name: Deploy to Firebase Hosting
on:
  # Preview every PR that targets main
  pull_request:
    branches: [main]

  # Manual trigger (preview or production)
  workflow_dispatch:
    inputs:
      environment:
        description: Where to deploy
        required: true
        default: preview
        type: choice
        options: [preview, production]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # -------- channel logic (live vs preview-123) ----------------------------
    env:
      CHANNEL_ID: >-
        ${{ github.event_name == 'pull_request'
              && format('pr-{0}', github.event.pull_request.number)
            || (github.event_name == 'workflow_dispatch'
                && inputs.environment == 'production')
              && 'live'
            || (github.event_name == 'push'
                && github.ref == 'refs/heads/main')
              && 'live'
            || format('preview-{0}', github.run_number) }}

    steps:
    # ------------------------------------------------------------------------#
    # 1.  Source & dependencies
    # ------------------------------------------------------------------------#
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with: { node-version: '20' }

    # Cache the global NPM folder for faster cold starts
    - name: Cache NPM
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

    - name: Install deps & build
      run: |
        npm ci
        npm run build
      env:
        # your Vite envs ‚Äì duplicated here & in build so VS Code‚Äôs
        # preview still works locally
        VITE_FIREBASE_PROJECT_ID: my-smart-shopper-e0c23
        VITE_FIREBASE_API_KEY:        ${{ secrets.FIREBASE_API_KEY }}
        VITE_FIREBASE_AUTH_DOMAIN:    ${{ secrets.FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID:         ${{ secrets.FIREBASE_APP_ID }}
        VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
        VITE_BACKEND_URL:             ${{ secrets.VITE_BACKEND_URL }}

    # ------------------------------------------------------------------------#
    # 2.  Deploy
    # ------------------------------------------------------------------------#
    - name: Deploy preview
      if: github.event_name == 'pull_request' ||
          (github.event_name == 'workflow_dispatch' &&
           (inputs.environment == '' || inputs.environment == 'preview'))
      id: deploy_preview
      uses: FirebaseExtended/action-hosting-deploy@v0.9.0
      with:
        repoToken:              ${{ github.token }}
        firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        projectId:              my-smart-shopper-e0c23
        entryPoint:             ${{ github.workspace }}
        channelId:              ${{ env.CHANNEL_ID }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    - name: Deploy production
      if: (github.event_name == 'workflow_dispatch' && inputs.environment == 'production') ||
          (github.event_name == 'push' && github.ref == 'refs/heads/main')
      uses: FirebaseExtended/action-hosting-deploy@v0.9.0
      with:
        repoToken:              ${{ github.token }}
        firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        projectId:              my-smart-shopper-e0c23
        entryPoint:             ${{ github.workspace }}
        channelId:              live
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    # ------------------------------------------------------------------------#
    # 3.  Smoke-test (follow 307 -> Render and wait up to 30 s)
    # ------------------------------------------------------------------------#
    - name: Smoke-test /api/health
      # skip if preview step didn't run (e.g., direct prod deploy)
      if: env.CHANNEL_ID == 'live' || steps.deploy_preview.outcome == 'success'
      env:
        BASE_URL: >-
          ${{ env.CHANNEL_ID == 'live'
                && 'https://my-smart-shopper-e0c23.web.app'
              || steps.deploy_preview.outputs.details_url }}
      run: |
        echo "üîÑ Pinging $BASE_URL/api/health"
        for i in {1..6}; do
          STATUS=$(curl -s -L -o /dev/null -w '%{http_code}' \
                   "$BASE_URL/api/health")
          if [ "$STATUS" = 200 ]; then
            echo "‚úÖ Hosting OK (HTTP 200)"; exit 0
          fi
          echo "   still $STATUS (try $i/6)‚Ä¶"; sleep 5
        done
        echo "‚ùå Hosting never reached 200"; exit 1
